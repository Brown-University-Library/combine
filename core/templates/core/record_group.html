{% extends 'core/base.html' %}

{% block content %}

	<div>
		<h3>Record Group: {{ record_group.name }}</h3>

		<table border="1" cellpadding="10">
			<tr>
				<th>Description</th>
				<td>{{ record_group.description }}</td>
			</tr>
			<tr>
				<th>Published Records</th>
				{% if record_group.jobpublish_set.all|length > 0 %}
					<td class="{{ record_group.jobpublish_set.all.first.job.job_type_family }}"><a href="{% url 'job_details' org_id=record_group.organization.id record_group_id=record_group.id job_id=record_group.jobpublish_set.all.first.job.id %}">{{ record_group.jobpublish_set.all.first.job.name }}, Job #{{ record_group.jobpublish_set.all.first.job.id }}</a></td>
				{% else %}
					<td style="color:red;">None</td>
				{% endif %}
			</tr>
			<tr>
				<th>Published Set ID</th>
				<td>{{ record_group.publish_set_id }}</td>
			</tr>
		</table>
	</div>

	<div>		
		<h3>Jobs</h3>

		<div id="job_family_diagram_container">
			<style type="text/css">
				#job_family_diagram {
					width: 100%;
					height: 400px;
					border: 1px solid lightgray;
				}
			</style>
			<div id="job_family_diagram"></div>
			<script type="text/javascript">

				// parse job lineage json
				job_lineage = JSON.parse('{{ job_lineage_json|safe }}');

				// style nodes
				$(job_lineage.nodes).each(function(){

					// add label
					this.label = this.name;

					// bump font
					this.font = {
						size:20
					};

					// add shadow
					this.shadow = {
				      enabled: true,
				      color: 'rgba(0,0,0,0.5)',
				      size:10,
				      x:5,
				      y:5
				    };

				    // set base node parameters
				    this.shape = 'box';
				    this.shapeProperties = {
						borderRadius: 10
					};
					this.physics = false;
					this.borderWidth = 2;
					this.borderWidthSelected = 5;

					// handle differences between job types
					// Harvests
					if (this.job_type == 'HarvestOAIJob' || this.job_type == 'HarvestStaticXMLJob'){
						this.color = '#deffde';
					}

					// Transform
					else if (this.job_type == 'TransformJob'){
						this.color = '#fffcde';
					}

					// Merge
					else if (this.job_type == 'MergeJob'){
						this.color = '#e3deff';
					}

					// Publish
					else if (this.job_type == 'PublishJob'){
						this.color = '#def3ff';
					}

					// override color is job is not valid
					if (!this.is_valid){
						this.color = '#ff9898';					
					}					

				});

				// style edges
				$(job_lineage.edges).each(function(){

					// add arrow
					this.arrows = {
      					to:{
  							enabled: true,
  							scaleFactor:1,
  							type:'arrow'
  						}
      				}
				});

				// init as viz data
				var nodes = new vis.DataSet(job_lineage.nodes);
				var edges = new vis.DataSet(job_lineage.edges);

				// create a network
				var container = document.getElementById('job_family_diagram');
				var data = {
					nodes: nodes,
					edges: edges
				};
				var options = {
					clickToUse:false,
					interaction:{
						zoomView:false	
					},
					layout:{
						hierarchical: {
							enabled:true,
							levelSeparation: 600,
							nodeSpacing: 100,
							treeSpacing: 100,
							blockShifting: true,
							edgeMinimization: true,
							parentCentralization: true,
							direction: 'LR',        // UD, DU, LR, RL
							sortMethod: 'directed'   // hubsize, directed
						}
					}			  	
				};

				// fire network
				var network = new vis.Network(container, data, options);

				// fit all nodes in viewport
				network.fit();

				// set listener for node select
				network.on('selectNode', function (node){

					// fire ajax to get job lineage for selected job
					base_url = "{% url 'job_lineage_json' org_id=record_group.organization.id record_group_id=record_group.id job_id='DYNAMIC_ID' %}";
					base_url = base_url.replace('DYNAMIC_ID',node.nodes[0]);
					console.log(base_url);
					$.ajax({
						type: 'POST',
						url: base_url,
						dataType:'json',
						data: {							
							'csrfmiddlewaretoken': '{{ csrf_token }}'
						},
						success: function(data){
							console.log(data);
							search_string = data.job_id_list.join('|');
							job_id = node.nodes[0];
							jobs_table.column(0).search(search_string, true, false).draw();
						}			
					});
					
				});

				// set listener for node deselect
				network.on('deselectNode', function (node){
					jobs_table.column(0).search('').draw();
				});

			</script>
		</div>

		<div>
			<!-- job datatable -->
			{% include 'core/jobs_dt_table.html' %}
		</div>
		
	</div>

	<div>
		<h3>Run new job</h3>
		<p>
			<ul>
				<li>Harvest:
					<ul>
						<li><a href="{% url 'job_harvest_oai' org_id=record_group.organization.id record_group_id=record_group.id %}">OAI-PMH</a></li>
						<li><a href="{% url 'job_harvest_static_xml' org_id=record_group.organization.id record_group_id=record_group.id %}">Static XML</a></li>
					</ul>
				</li>
				<li><a href="{% url 'job_transform' org_id=record_group.organization.id record_group_id=record_group.id %}">Transform</a></li>
				<li><a href="{% url 'job_merge' org_id=record_group.organization.id record_group_id=record_group.id %}">Merge</a></li>
				<li><a href="{% url 'job_publish' org_id=record_group.organization.id record_group_id=record_group.id %}">Publish</a></li>
			</ul>
		</p>
	</div>

{% endblock %}