{% extends 'core/base.html' %}
{% load static %}
{% block content %}

	<div class="row">
		<div class="col-md-12">	
			<h3>Job Details: <span class="font-weight-bold {{ cjob.job.job_type_family }} {% if cjob.job.deleted %}deleted{% endif %}">{{ cjob.job.name }}</span> <a href="#" onclick="$('#job_name_update').fadeToggle(); return false;"><img src="{% static 'core/img/pencil.png' %}" height=10 /></a> <button type="button" class="btn btn-outline-info btn-sm" onclick="$('#job_notes_section').fadeToggle();">Job Notes</button></h3>
			<div id="job_name_update" style="display:none; margin-top:10px; padding:10px; border-radius:10px; background-color:pink;">
				<form method="POST" action="{% url 'job_update_name' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">
					{% csrf_token %}																		
					<div class="form-group">
						<label for="job_name">Enter new job name</label>
						<input type="text" class="form-control" id="job_name" name="job_name" placeholder="Better Job Name">
					</div>
					<button type="submit" class="btn btn-primary btn-sm">Update</button>
				</form>
			</div>
		</div>
		<div class="col-md-12">
			<!-- <p><button type="button" class="btn btn-outline-info btn-sm" onclick="$('#job_notes_section').slideToggle();">Job Notes</button> -->
			<div id="job_notes_section" style="display:none;">
				<form method="POST" action="{% url 'job_update_note' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">
					{% csrf_token %}
					
					<div class="form-group">						
						<textarea class="form-control" name="job_note" id="job_notes" rows="3" placeholder="Enter Job notes here...">{{ cjob.job.note }}</textarea>
					</div>
					<input type="hidden" name="job_id" value="{{ cjob.job.id }}">
					<input type="hidden" name="next" value="{{ request.path }}">
					<button type="submit" class="btn btn-primary btn-sm">Update Notes</button>
				</form>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<div id="job_family_diagram_container">
				<style type="text/css">
					#job_family_diagram {				
						height: 200px;				
					}
				</style>		
				<div id="job_family_diagram"></div>
				<script type="text/javascript">

					// parse job lineage json
					job_lineage = JSON.parse('{{ job_lineage_json|safe }}');										

					// style nodes
					$(job_lineage.nodes).each(function(){
						styleNetworkNodes(this);						
					});

					// style edges
					$(job_lineage.edges).each(function(){
						styleNetworkEdges(this);
					});

					// init as viz data
					var nodes = new vis.DataSet(job_lineage.nodes);
					var edges = new vis.DataSet(job_lineage.edges);

					// create a network
					var container = document.getElementById('job_family_diagram');
					var data = {
						nodes: nodes,
						edges: edges
					};
					var options = {
						clickToUse:false,
						interaction:{
							zoomView:false,
							multiselect: false,
							navigationButtons: true,
						},
						layout:{
							hierarchical: {
								enabled:true,
								levelSeparation: 600,
								nodeSpacing: 100,
								treeSpacing: 100,
								blockShifting: true,
								edgeMinimization: true,
								parentCentralization: true,
								direction: 'LR',        // UD, DU, LR, RL
								sortMethod: 'directed'   // hubsize, directed
							}
						}			  	
					};

					// fire network
					var network = new vis.Network(container, data, options);

					// fit all nodes in viewport
					network.fit();

				</script>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<table class="table table-bordered table-hover">
				<tr>
					<th>Job Name</th>					
					<th>Job Type</th>
					<th>Total Input Records</th>
					<th>Successfully Processed</th>
					<th>Error in Processing</th>										
					<th>Failed Validation</th>
				</tr>
				<tr class="{{ cjob.job.job_type_family }} {% if cjob.job.deleted %}deleted{% endif %}">
					<td>{{ cjob.job.name }}</td>					
					<td>{{ cjob.job.job_type }}</td>
					<td>{{ record_count_details.input_jobs.total_input_records }}</td>
					<td>{{ record_count_details.records }}</td>
					<td>{{ record_count_details.errors }}</td>					
					<td style="{% if cjob.job.validation_results.failure_count > 0 %}background-color: #ff9898;{% else %}background-color: #cbffcb;{% endif %}">{{ cjob.job.validation_results.failure_count }}</td>
				</tr>
			</table>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">

			<div class="alert alert-info alert-dismissible fade show" role="alert">
				The following tabs provide additional information about this Job
				<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<!-- Navigation -->
			<ul id="tabs" class="nav nav-tabs">								
				<li class="nav-item">
					<a class="nav-link active" data-toggle="tab" href="#records_tab">Records</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#field_breakdown_tab">Field Analysis</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#io_tab">Input Jobs</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#validation_tab">Validation</a>
				</li>								
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#dpla_bulk_data_tab" onclick="update_table_widths();">DPLA Bulk Data Matches</a>						
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#job_type_specific_tab" onclick="update_table_widths();">{% if cjob.job.job_type_family == 'HarvestJob' %}Harvest Details{% elif cjob.job.job_type_family == 'TransformJob' %}Transform Details{% elif cjob.job.job_type_family == 'MergeJob' %}Merge / Duplciate Details{% elif cjob.job.job_type_family == 'PublishJob' %}Publish Details{% elif cjob.job.job_type_family == 'AnalysisJob' %}Analysis Details{% endif %}</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#export_tab">Export</a>
				</li>
			</ul>

			<!-- Tabbed Content -->
			<div class="tab-content">			

				<div id="records_tab" class="tab-pane container full_width_tab active">
					<div class="row">		
						<div class="col-md-12">
							<!-- Indexing Records DT Table -->
							{% include 'core/records_dt_table.html' %}
						</div>
					</div>
				</div>

				<div id="io_tab" class="tab-pane container full_width_tab">
					<div class="row">
		
						<!-- Job Inputs -->
						{% if cjob.job.job_type_family != 'HarvestJob' %}
						<div class="col-md-12">
							<h4>Input Jobs</h4>
							<p>The following Jobs were used as input for this <strong>{{ cjob.job.job_type_family }}</strong>.</p>
							<table class="table table-bordered table-hover">
								<tr>
									<th>Input Job Name</th>					
									<th>Job Type</th>
									<th>Record Input Type</th>
									<th>Record Count</th>
								</tr>
								{% for input_job in cjob.job.jobinput_set.all %}
								<tr class="{{ input_job.input_job.job_type_family }} {% if input_job.input_job.deleted %}deleted{% endif %}">
									<td><a href="{% url 'job_details' org_id=input_job.input_job.record_group.organization.id record_group_id=input_job.input_job.record_group.id job_id=input_job.input_job.id %}">{{ input_job.input_job.name }}</a></td>					
									<td>{{ input_job.input_job.job_type }}</td>
									<td>{{ input_job.get_input_validity_valve_display }}</td>
									<td>
										{% if input_job.input_validity_valve == 'all' %}
											{{ input_job.input_job.record_count }}
										{% elif input_job.input_validity_valve == 'valid' %}
											{{ input_job.input_job.validation_results.passed_count }}
										{% elif input_job.input_validity_valve == 'invalid' %}
											{{ input_job.input_job.validation_results.failure_count }}
										{% endif %}
									</td>
								</tr>
								{% endfor %}
								<tr>
									<td></td>
									<td></td>									
									<td><strong>Total:</strong></td>
									<td>{{ record_count_details.input_jobs.total_input_records }}</td> <!-- NEED TO FIX THIS -->
								</tr>
							</table>
						</div>
						{% else %}
						<div class="col-md-12">
							<p>No Jobs were used as input for this Job.</p>
						</div>
						{% endif %}

					</div>
				</div>

				<div id="validation_tab" class="tab-pane container full_width_tab">
					{% if cjob.job.jobvalidation_set.count > 0 %}
					<div class="row">		
						<div class="col-md-12">
							<h3>Validation Scenarios</h3>
							<p>The following Validation Scenarios were run for this job:</p>
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Validation Name</th>
										<th>Validation Type</th>
										<th>Record Validation Failure Count</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									{% for jv in cjob.job.jobvalidation_set.all %}			
										<tr>
											<td>{{ jv.validation_scenario.name }}</td>
											<td>{{ jv.validation_scenario.get_validation_type_display }}</td>
											<td style="{% if jv.validation_failure_count > 0 %}background-color: #ff9898;{% else %}background-color: #cbffcb;{% endif %}">{{ jv.validation_failure_count }}</td>
											<td>{% if jv.validation_failure_count > 0 %}<a target="_blank" href="{% url 'job_validation_scenario_failures' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id job_validation_id=jv.id %}">See Failures{% endif %}</a></td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
							{% if cjob.job.validation_results.verdict == False %}							
								<p><a href="{% url 'job_reports_create_validation' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}"><button type="button" class="btn btn-success btn-sm">Run validation results report</button></a></p>
							{% endif %}
						</div>
					</div>
					{% else %}
					<div class="row">		
						<div class="col-md-12">
							<p>No Validations were run for this Job.</p>
						</div>
					</div>

					{% endif %}
				</div>

				<div id="field_breakdown_tab" class="tab-pane container full_width_tab">
					<div class="row">
						<div class="col-md-12">
							<h3>Field Analysis</h3>
							<p>To get a sense of how fields are used and distributed across a job, each record is mapped to a flat representation of its metadata, and then indexed in ElasticSearch.  The field names should suggest that corresponding metadata field from the original XML.</p>
						</div>
						<div class="col-md-6">
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Total Records for Job</th>
										<th>Successfully Indexed</th>						
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>{{ record_count_details.records }}</td>
										<td>{{ field_counts.total_docs }}</td>						
										<td><a href="http://{{ APP_HOST }}:9200/j{{ cjob.job.id }}/_search" target="_blank">Browse Index</a> / <a href="{% url 'job_indexing_failures' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">View Errors</a></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>

					<!-- Indexed Fields Analysis DT Table -->
					{% include 'core/indexed_fields_dt_table.html' %}
				</div>

				<div id="dpla_bulk_data_tab" class="tab-pane container full_width_tab">
					
					{% if dpla_bulk_data_matches %}

						<div class="row">
							<div class="col-md-12">
								<p>The following tables shows matches and misses based on the Record's Identifier as run against the selected DPLA Bulk Data dump.</p>
								<table class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>DPLA Bulk Data Download</th>
											<th>Total Records in Job</th>
											<th>Matches</th>
											<th>Misses</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td><code>{{ dpla_bulk_data_matches.dbdd.s3_key }}</code></td>
											<td>{{ record_count_details.records }}</td>
											<td><a href="#">{{ dpla_bulk_data_matches.matches.count }}</a></td>
											<td><a href="#">{{ dpla_bulk_data_matches.misses.count }}</a></td>
									</tbody>
								</table>
							</div>
						</div>

						<!-- DataTable of DPLA Matches -->	
						<div class="row">
							<div class="col-md-12">
								<h4>Matches</h4>
								<table id='dpla_bulk_data_matches_table' class="table table-bordered table-hover dt_table">
									<thead>
										<th>DB ID</th>
										<th>Record ID</th>										
									</thead>
									<tbody></tbody>
								</table>
							</div>
						</div>

						<!-- DataTable of DPLA Misses -->	
						<div class="row">
							<div class="col-md-12">
								<h4>Misses</h4>
								<table id='dpla_bulk_data_misses_table' class="table table-bordered table-hover dt_table">
									<thead>
										<th>DB ID</th>
										<th>Record ID</th>										
									</thead>
									<tbody></tbody>
								</table>
							</div>
						</div>

						<script>

							// Matches Datatable
							$(document).ready(function() {
							    matches_table = $('#dpla_bulk_data_matches_table').dataTable({
							        "processing": true,
							        "serverSide": true,
							        "ajax": "{% url 'dpla_bulk_data_matches' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id match_type='matches' %}",
							        "searchDelay": 1000,
							        "pageLength": 10,
							        "order": [[ 1, "desc" ]],
							        "columns": [
							            { 
							            	title: "DB ID"
						            	},
							            { 
							            	title: "Record ID"
							            }									            
							        ],
							    });
							});

							// Misses Datatable
							$(document).ready(function() {
							    misses_table = $('#dpla_bulk_data_misses_table').dataTable({
							        "processing": true,
							        "serverSide": true,
							        "ajax": "{% url 'dpla_bulk_data_matches' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id match_type='misses' %}",
							        "searchDelay": 1000,
							        "pageLength": 10,
							        "order": [[ 1, "desc" ]],
							        "columns": [
							            { 
							            	title: "DB ID"
						            	},
							            { 
							            	title: "Record ID"
							            }									            
							        ],
							    });
							});
						
						</script>

					{% else %}

						<div class="row">
							<div class="col-md-12">
								<p>No DPLA Bulk Data Comparisons were made, or no matches found.</p>
							</div>
						</div>

					{% endif %}
				</div>

				<div id="job_type_specific_tab" class="tab-pane container full_width_tab">
					<!-- Details specific to Job Type -->
					<div class="row">
						<div class="col-md-12">
							<div id="job_type_specific">

								<!-- HarvestJob -->
								{% if cjob.job.job_type_family == 'HarvestJob' %}
									<p>No additional information at this time for Harvest jobs.</p>
								{% endif %}

								<!-- TransformJob -->			
								{% if cjob.job.job_type_family == 'TransformJob' %}									
									<p>See below for a table of all records that were altered in some way during this Transform Job.  Click into a Record and then click the tab <strong>"Transform Details"</strong> to view detailed changes for that Record.</p>									

									<!-- Record Diff table -->
									<table id='job_record_diffs' class="table table-bordered table-hover dt_table">
										<thead>
											<th>DB ID</th>
											<th>Record ID</th>
										</thead>
										<tbody></tbody>
									</table>

									<script>
										// Matches Datatable
										$(document).ready(function() {
										    matches_table = $('#job_record_diffs').dataTable({
										        "processing": true,
										        "serverSide": true,
										        "ajax": "{% url 'job_record_diffs' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}",
										        "searchDelay": 1000,
										        "pageLength": 10,
										        "order": [[ 1, "desc" ]],
										        "columns": [
										            { 
										            	title: "DB ID"
									            	},
										            { 
										            	title: "Record ID"
										            }									            
										        ],
										    });
										});
									</script>


								{% endif %}

								<!-- MergeJob -->
								{% if cjob.job.job_type_family == 'MergeJob' %}
									<p>No additional information at this time for Duplicate / Merge / Analysis jobs.</p>
								{% endif %}

								<!-- PublishJob -->
								{% if cjob.job.job_type_family == 'PublishJob' %}
									<p>No additional information at this time for Publish jobs.</p>
								{% endif %}

								<!-- AnalysisJob -->
								{% if cjob.job.job_type_family == 'AnalysisJob' %}
									<p>No additional information at this time for Analysis jobs.</p>
								{% endif %}

							</div>
						</div>
					</div>
				</div>

				<div id="export_tab" class="tab-pane container full_width_tab">
					<div class="row">		
						<div class="col-md-12">

							<h3>Job Export</h3>
							<p>Jobs may be exported in two ways (<a href="#">see documentation for more information</a>):
								<ul>
									<li><strong>Documents (XML)</strong>: The actual XML documents for each Record, as harvested and/or transformed.</li>
									<li><strong>Mapped Fields (tabular)</strong>: Records are also <a href="http://combine.readthedocs.io/en/master/analysis.html#analyzing-indexed-fields">indexed into ElasticSearch</a>, resulting in a flat, tabular format of the data from the Records.</li>
								</ul>
							</p>

							<div class="alert alert-info alert-dismissible fade show" role="alert">
								Select a tab below to export Records as Documents, or their Mapped Fields
								<button type="button" class="close" data-dismiss="alert" aria-label="Close">
								<span aria-hidden="true">&times;</span>
								</button>
							</div>
							
							<ul id="export_tabs" class="nav nav-tabs">								
								<li class="nav-item">
									<a class="nav-link active" data-toggle="tab" href="#export_mapped_fields">Export Records as Mapped Fields</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" data-toggle="tab" href="#export_documents">Export Records as Documents</a>
								</li>								
							</ul>

							<div class="tab-content">			

								<div id="export_mapped_fields" class="tab-pane container full_width_tab active">
									<div class="row">		
										<div class="col-md-6">

											<!-- form for Job mapped fields export -->
											<form method="POST" action="{% url 'job_export_mapped_fields' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">

												{% csrf_token %}

												<!-- consider not allowing custom report name -->
												<!-- <div class="form-group">
													<label for="export_name">Export Job Name</label>
													<input type="text" class="form-control" name="export_name" id="export_name" placeholder="Post-Transform Analysis">
													<small id="export_name_help" class="form-text text-muted">Optional</small>
												</div> -->

												<div class="form-group">
													<div class="form-check">
														<input class="form-check-input" type="checkbox" value="true" id="kibana_style" name="kibana_style">
														<label class="form-check-label" for="validation_scenario_{{ vs.id }}">
															Check this box to export repeating fields "Kibana style" <button type="button" class="btn btn-outline-info btn-sm" onclick="$('#kibana_style_info').fadeToggle();">More Information</button>
														</label>
													</div>
													<div id="kibana_style_info" class="bg-light" style="padding:20px; border-radius:5px; display: none;">
														<p>"Kibana style" is referring to the <a href="https://www.elastic.co/products/kibana">Kibana application</a> for visualize and analyzing ElasticSearch indexes, and addresses fields that have <strong>multiple values</strong>.</p>

														<p>For example, consider an ElasticSearch field called <code>mods_subject_topic</code>, with multiple values of <code>history</code>, <code>boating</code>, and <code>typing</code>.  If Kibana style is <strong>not</strong> checked/used -- which is the default behavior -- this would result in three distinct columns in the generated .csv file with a number affixed to the field name: <code>mods_subject_topic.0</code> with the value <code>historyM</code>, <code>mods_subject_topic.1</code> with the value <code>boating</code>, and <code>mods_subject_topic.2</code> with the value <code>typing</code>.  This can handy for analysis, as distinct values for this field are in distinct columns.</p>

														<p>But some pipelines are prepared for fields that are comman separated when repeating, e.g. Kibana.  If checked, the result would be a <strong>single</strong> field called <code>mods_subject_topic</code> and a single, comma separated value of <code>history,boating,typing</code>.
													</div>
												</div>

												<button type="submit" class="btn btn-success btn-sm">Export Mapped Fields</button>

											</form>

										</div>
									</div>
								</div>

								<div id="export_documents" class="tab-pane container full_width_tab">
									<div class="row">		
										<div class="col-md-12">
											<p>Stay Tuned.</p>
										</div>
									</div>
								</div>

							</div>

						</div>
					</div>
				</div>

			</div>

		</div>
	</div>

	<script>

		function update_table_widths() {			
			$(".dt_table").css('width', '100%').dataTable().fnAdjustColumnSizing();
		}

	</script>


{% endblock %}


