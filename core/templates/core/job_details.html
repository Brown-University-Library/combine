{% extends 'core/base.html' %}
{% load static %}
{% block content %}
{% load core_template_filters %}

	<div class="row">
		<div class="col-md-12">
			<h3>Job Details: <span class="font-weight-bold {{ cjob.job.job_type_family }} {% if cjob.job.deleted %}deleted{% endif %}">{{ cjob.job.name }}</span> <a href="#" onclick="$('#job_name_update').fadeToggle(); return false;"><img src="{% static 'core/img/pencil.png' %}" height=10 /></a> <button type="button" class="btn btn-outline-info btn-sm" onclick="$('#job_notes_section').fadeToggle();">Job Notes</button></h3>
			<div id="job_name_update" style="display:none; margin-top:10px; padding:10px; border-radius:10px; background-color:pink;">
				<form method="POST" action="{% url 'job_update_name' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">
					{% csrf_token %}
					<div class="form-group">
						<label for="job_name">Enter new job name</label>
						<input type="text" class="form-control" id="job_name" name="job_name" placeholder="Better Job Name">
					</div>
					<button type="submit" class="btn btn-primary btn-sm">Update</button>
				</form>
			</div>
		</div>
		<div class="col-md-12">
			<div id="job_notes_section" style="display:none;">
				<form method="POST" action="{% url 'job_update_note' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">
					{% csrf_token %}
					
					<div class="form-group">
						<textarea class="form-control" name="job_note" id="job_notes" rows="3" placeholder="Enter Job notes here...">{{ cjob.job.note }}</textarea>
					</div>
					<input type="hidden" name="job_id" value="{{ cjob.job.id }}">
					<input type="hidden" name="next" value="{{ request.path }}">
					<button type="submit" class="btn btn-primary btn-sm">Update Notes</button>
				</form>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<div id="job_family_diagram_container">
				<style type="text/css">
					#job_family_diagram {
						height: 200px;
					}
				</style>
				<div id="job_family_diagram"></div>
				<script type="text/javascript">

					// parse job lineage json
					job_lineage = JSON.parse('{{ job_lineage_json|safe }}');

					// style nodes
					$(job_lineage.nodes).each(function(){
						styleNetworkNodes(this);
					});

					// style edges
					$(job_lineage.edges).each(function(){
						styleNetworkEdges(this);
					});

					// init as viz data
					var nodes = new vis.DataSet(job_lineage.nodes);
					var edges = new vis.DataSet(job_lineage.edges);

					// create a network
					var container = document.getElementById('job_family_diagram');
					var data = {
						nodes: nodes,
						edges: edges
					};
					var options = {
						clickToUse:false,
						interaction:{
							zoomView:false,
							multiselect: false,
							navigationButtons: true,
						},
						layout:{
							hierarchical: {
								enabled:true,
								levelSeparation: 720,
								nodeSpacing: 100,
								treeSpacing: 100,
								blockShifting: true,
								edgeMinimization: true,
								parentCentralization: true,
								direction: 'LR',        // UD, DU, LR, RL
								sortMethod: 'directed'   // hubsize, directed
							}
						}
					};

					// fire network
					var network = new vis.Network(container, data, options);

					// fit all nodes in viewport
					network.fit();

				</script>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<table class="table table-bordered table-hover">
				<tr>
					<th>Job Name</th>
					<th>Job Type</th>
					<th>Total Input Records</th>
					<th>Successfully Processed</th>
					<th>Error in Processing</th>
					<th>Failed Validation</th>
				</tr>
				<tr class="{{ cjob.job.job_type_family }} {% if cjob.job.deleted %}deleted{% endif %}">
					<td>{{ cjob.job.name }}</td>
					<td>{{ cjob.job.job_type }}</td>
					<td>{{ record_count_details.input_jobs.total_input_records }}</td>
					<td>{{ record_count_details.records }}</td>
					<td>{{ record_count_details.errors }}</td>
					<td style="{% if cjob.job.validation_results.failure_count > 0 %}background-color: #ff9898;{% else %}background-color: #cbffcb;{% endif %}">{{ cjob.job.validation_results.failure_count }}</td>
				</tr>
			</table>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">

			<!-- <div class="alert alert-info alert-dismissible fade show" role="alert">
				The following tabs provide additional information about this Job
				<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div> -->

			<!-- Navigation -->
			<ul id="tabs" class="nav nav-tabs">
				<li class="nav-item">
					<a class="nav-link active" data-toggle="tab" href="#records_tab" onclick="update_table_widths();">Records</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#field_breakdown_tab" onclick="update_table_widths();">Mapped Fields</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#publish_tab">Publish</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#io_tab">Input Jobs</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#validation_tab">Validation</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#dpla_bulk_data_tab" onclick="update_table_widths();">DPLA Bulk Data Matches</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#job_type_specific_tab" onclick="update_table_widths();">{% if cjob.job.job_type_family == 'HarvestJob' %}Harvest Details{% elif cjob.job.job_type_family == 'TransformJob' %}Transform Details{% elif cjob.job.job_type_family == 'MergeJob' %}Merge / Duplicate Details{% elif cjob.job.job_type_family == 'PublishJob' %}Publish Details{% elif cjob.job.job_type_family == 'AnalysisJob' %}Analysis Details{% endif %}</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#export_tab">Export</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-toggle="tab" href="#spark_details_tab">Spark Details</a>
				</li>
			</ul>

			<!-- Tabbed Content -->
			<div class="tab-content">

				<div id="records_tab" class="tab-pane full_width_tab active">
					<div class="row">
						<div class="col-md-12">
							<!-- Indexing Records DT Table -->
							{% include 'core/records_dt_table.html' %}
						</div>
					</div>
				</div>

				<div id="publish_tab" class="tab-pane full_width_tab">
					<div class="row">
						<div class="col-md-12">
							<h4>Publish Job</h4>
						</div>
					</div>

					{% if cjob.job.published %}
					<div class="row">
						<div class="col-md-12">
							<p>This Job is currently <strong>published</strong>:</p>
							<table class="table table-bordered table-hover">
								<thead>									
									<tr>
										<th>Publish Set ID</th>
										<th>Record Count</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>
											{% if cjob.job.publish_set_id %}
												<a href="{% url 'oai' %}?verb=ListRecords&set={{ cjob.job.publish_set_id }}" target="_blank">{{ cjob.job.publish_set_id }}</a>
											{% else %}
												<span style="color:red;"><strong>Not set</strong></span>
											{% endif %}
										</td>
										<td>{{ cjob.job.record_count }}</td>
										<td><a onclick="return confirm('Are you sure you want to unpublish this Job?');" href="{% url 'job_unpublish' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}"><button type="button" class="btn btn-danger btn-sm">Unpublish</button></a></td>										
									</tr>
								</tbody>
							</table>
						</div>
					</div>

					{% else %}								
					<div class="row">
						<div class="col-md-6">
							<p>This job is currently <strong>unpublished</strong>.  Publish using the form below:</p>
							<form method="GET" action="{% url 'job_publish' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">
								{% csrf_token %}
								<div class="form-group">
									<label for="publish_set_id">Publish Set Id</label>
									<input type="text" class="form-control" id="publish_set_id" name="publish_set_id" placeholder="e.g. fedora_records"/>
								</div>
								<button type="submit" class="btn btn-success btn-sm">Publish Job</button>
							</form>
						</div>
					</div>

					{% endif %}
				</div>

				<div id="io_tab" class="tab-pane full_width_tab">
					<div class="row">
		
						<!-- Job Inputs -->
						{% if cjob.job.job_type_family != 'HarvestJob' %}
						<div class="col-md-12">
							<h4>Input Jobs</h4>
							<p>The following Jobs were used as input for this <strong>{{ cjob.job.job_type_family }}</strong>.</p>
							<table class="table table-bordered table-hover">
								<tr>
									<th>Input Job Name</th>
									<th>Job Type</th>
									<th>Validity of Records Passed</th>
									<th>Record Limit</th>
									<th>Total Passed Records</th>
								</tr>
								{% for input_job in cjob.job.jobinput_set.all %}
								<tr class="{{ input_job.input_job.job_type_family }} {% if input_job.input_job.deleted %}deleted{% endif %}">
									<td><a href="{% url 'job_details' org_id=input_job.input_job.record_group.organization.id record_group_id=input_job.input_job.record_group.id job_id=input_job.input_job.id %}">{{ input_job.input_job.name }}</a></td>
									<td>{{ input_job.input_job.job_type }}</td>
									<td>{{ input_job.get_input_validity_valve_display }}</td>
									<td>{{ input_job.input_numerical_valve }}</td>
									<td>{{ input_job.calc_passed_records }}</td>
								</tr>
								{% endfor %}
								<tr>
									<td></td>
									<td></td>
									<td></td>
									<td><strong>Total:</strong></td>
									<td>{{ record_count_details.input_jobs.total_input_record_count }}</td>
								</tr>
							</table>
						</div>
						{% else %}
						<div class="col-md-12">
							<p>No Jobs were used as input for this Job.</p>
						</div>
						{% endif %}

					</div>
				</div>

				<div id="validation_tab" class="tab-pane full_width_tab">
					<div class="row">
						<div class="col-md-12">
							<h3>Validation Scenarios</h3>
						</div>
					</div>

					<div class="row">
						<div class="col-md-12">

							{% if cjob.job.jobvalidation_set.count > 0 %}
								<p>The following Validation Scenarios have been run for this Job:</p>
								<table class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>Validation</th>
											<th>Validation Type</th>
											<th>Record Validation Failure Count</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for jv in cjob.job.jobvalidation_set.all %}
											<tr>
												<td>{{ jv.validation_scenario.name }}</td>
												<td>{{ jv.validation_scenario.get_validation_type_display }}</td>
												<td style="{% if jv.validation_failure_count > 0 %}background-color: #ff9898;{% else %}background-color: #cbffcb;{% endif %}">{{ jv.validation_failure_count }}</td>
												<td>
													{% if jv.validation_failure_count > 0 %}
														<p><a href="{% url 'job_validation_scenario_failures' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id job_validation_id=jv.id %}"><button type="button" class="btn btn-primary btn-sm">See Failures for this Validation</button></a></p>
													{% endif %}
													<p><form method="POST" action="{% url 'job_update' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">{% csrf_token %}<input type="hidden" name="update_type" value="remove_validation" ></input><input type="hidden" name="jv_id" value="{{jv.id}}"></input><button type="submit" class="btn btn-danger btn-sm">Remove Validation from Job</button></form></p>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
								{% if cjob.job.validation_results.verdict == False %}
									<p><a href="{% url 'job_reports_create_validation' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}"><button type="button" class="btn btn-success btn-sm">Generate Validation Results Report</button></a></p>
									{% endif %}

							{% else %}
								<p>No Validations have been run for this Job.</p>
							{% endif %}
						</div>

					</div>

					<div class="row">
						<div class="col-md-12">
							<p><a href="{% url 'job_update' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}?update_type=validations"><button type="button" class="btn btn-success btn-sm">Run new Validations for this Job</button></a></p>
						</div>
					</div>

				</div>

				<div id="field_breakdown_tab" class="tab-pane full_width_tab">
					<div class="row">
						<div class="col-md-8">
							<!-- <p>To get a sense of how fields are used and distributed across a job, each record is mapped to a flat representation of its metadata, and then indexed in ElasticSearch.</p> -->
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Total Records for Job</th>
										<th>Successfully Mapped</th>										
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>{{ record_count_details.records }}</td>
										<td>{% if field_counts %}{{ field_counts.total_docs }}{% else %}0{% endif %}</td>
										<td>
											<ul class="list-inline">
												<li style="display:inline;"><a href="#" onclick="$('#job_fm_config_json_container').toggle(); return false;"><button type="button" class="btn btn-info btn-sm">Show Field Mapping Configuration Used</button></a></li>
												<li style="display:inline;"><a href="http://{{ APP_HOST }}:9200/j{{ cjob.job.id }}/_search" target="_blank"><button type="button" class="btn btn-info btn-sm">Browse ElasticSearch Index</button></a></li>
												<li style="display:inline;"><a href="{% url 'job_indexing_failures' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}"><button type="button" class="btn btn-danger btn-sm">View Mapping and Indexing Errors</button></a></li>
												<li style="display:inline;"><a href="{% url 'job_update' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}?update_type=reindex"><button type="button" class="btn btn-success btn-sm">Re-Map and Re-Index Fields</button></a></li>
											</ul>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>

					<div id="job_fm_config_json_container" class="row" style="display:none;">
						<div class="col-md-12">
							<p>The following Field Mapper configurations were used for this Job:</p>
							
							<div id="jsoneditor" style="height:450px;"></div>
							<script>
						        // create the editor
						        var container = document.getElementById("jsoneditor");
						        var options = {
						        	mode: 'code',
			    					modes: ['code', 'text', 'view'],
			    					sortObjectKeys: true,
			    					name: 'field_mapping_configuration',
			    					onModeChange: function(nm, om){
			    						if (nm == 'view'){
			    							$("#jsoneditor").css('height','');
			    						}
			    						else {
			    							$("#jsoneditor").css('height','450px');
			    						}
			    					},
			    					navigationBar:false
						        };
						        var editor = new JSONEditor(container, options);

						        // set json to editor
						        editor.set({{ job_fm_config_json|safe }});
						    </script>
						</div>
					</div>

					<!-- Indexed Fields Analysis DT Table -->
					{% include 'core/indexed_fields_dt_table.html' %}
				</div>

				<div id="dpla_bulk_data_tab" class="tab-pane full_width_tab">
					
					{% if dpla_bulk_data_matches %}

						<div class="row">
							<div class="col-md-12">
								<p>A DPLA Bulk Data comparison was run for this Job, by looking for matching URL values for the mapped field <code>dpla_isShownAt</code> in Combine Records, and <code>isShownAt</code> in DPLA Items from bulk data.  The following table shows matches and misses.</p>
								<table class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>DPLA Bulk Data Download</th>
											<th>Total Records in Job</th>
											<th>Matches</th>
											<th>Misses</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td><code>{{ dpla_bulk_data_matches.dbdd.s3_key }}</code></td>
											<td>{{ record_count_details.records }}</td>
											<td class="bg_light_green">{{ dpla_bulk_data_matches.matches }}</td>
											<td class="bg_light_red">{{ dpla_bulk_data_matches.misses }}</td>
									</tbody>
								</table>
							</div>
						</div>

						<!-- DataTable of DPLA Matches -->
						<div class="row">
							<div class="col-md-12">
								<h4>Record Matches</h4>
								<table id='dpla_bulk_data_matches_table' class="table table-bordered table-hover dt_table">
									<thead>
										<th>DB ID</th>
										<th>Record ID</th>
									</thead>
									<tbody></tbody>
								</table>
							</div>
						</div>

						<!-- DataTable of DPLA Misses -->
						<div class="row">
							<div class="col-md-12">
								<h4>Record Misses</h4>
								<table id='dpla_bulk_data_misses_table' class="table table-bordered table-hover dt_table">
									<thead>
										<th>DB ID</th>
										<th>Record ID</th>
									</thead>
									<tbody></tbody>
								</table>
							</div>
						</div>

						<script>

							// Matches Datatable
							$(document).ready(function() {
							    matches_table = $('#dpla_bulk_data_matches_table').dataTable({
							        "processing": true,
							        "serverSide": true,
							        "ajax": "{% url 'dpla_bulk_data_matches' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id match_type='matches' %}",
							        "searchDelay": 1000,
							        "pageLength": 10,
							        "order": [[ 1, "desc" ]],
							        "columns": [
							            {
							            	title: "DB ID"
						            	},
							            {
							            	title: "Record ID"
							            }
							        ],
							    });
							});

							// Misses Datatable
							$(document).ready(function() {
							    misses_table = $('#dpla_bulk_data_misses_table').dataTable({
							        "processing": true,
							        "serverSide": true,
							        "ajax": "{% url 'dpla_bulk_data_matches' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id match_type='misses' %}",
							        "searchDelay": 1000,
							        "pageLength": 10,
							        "order": [[ 1, "desc" ]],
							        "columns": [
							            {
							            	title: "DB ID"
						            	},
							            {
							            	title: "Record ID"
							            }
							        ],
							    });
							});
						
						</script>

					{% else %}

						<div class="row">
							<div class="col-md-12">
								<p>No DPLA Bulk Data Comparisons have been done for this Job.</p>
							</div>
						</div>

					{% endif %}

					<div class="row">
						<div class="col-md-12">
							<p><a href="{% url 'job_update' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}?update_type=dbdm"><button type="button" class="btn btn-success btn-sm">Run new DPLA Bulk Data match for this Job</button></a></p>
						</div>
					</div>

				</div>

				<div id="job_type_specific_tab" class="tab-pane full_width_tab">

					<!-- Details specific to Job Type -->
					<div class="row">
						<div class="col-md-12">
							<div id="job_type_specific">

								<!-- HarvestJob -->
								{% if cjob.job.job_type_family == 'HarvestJob' %}
									
									{% if job_details.oai_endpoint %}
										<h4>OAI Endpoint for Harvest</h3>										
										<table class="table table-bordered table-hover">
											<thead>
												<tr>
													<th>ID</th>
													<th>Name</th>
													<th>Endpoint URL</th>
													<th>Verb</th>
													<th>Metadata Prefix</th>
													<th>Scope Type</th>
													<th>Scope Value</th>
													<th>Actions</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td>{{job_details.oai_endpoint.id}}</td>
													<td>{{job_details.oai_endpoint.name}}</td>
													<td><a href="{{job_details.oai_endpoint.endpoint}}?verb=Identify" target="_blank">{{job_details.oai_endpoint.endpoint}}</a></td>
													<td><code>{{job_details.oai_overrides.verb}}</code></td>
													<td><code>{{job_details.oai_overrides.metadataPrefix}}</code></td>
													<td><code>{{job_details.oai_overrides.scope_type}}</code></td>
													<td><code>{{job_details.oai_overrides.scope_value}}</code></td>
													<td><a href="{{job_details.oai_endpoint.endpoint}}?verb=ListSets" target="_blank">List Sets</a></td>
												</tr>
											</tbody>											
										</table>
									{% endif %}

								{% endif %}

								<!-- TransformJob -->
								{% if cjob.job.job_type_family == 'TransformJob' %}
									<p>See below for a table of all records that were altered in some way during this Transform Job.  Click into a Record and then click the tab <strong>"Transform Details"</strong> to view detailed changes for that Record.</p>

									<!-- Record Diff table -->
									<table id='job_record_diffs' class="table table-bordered table-hover dt_table">
										<thead>
											<th>DB ID</th>
											<th>Record ID</th>
										</thead>
										<tbody></tbody>
									</table>

									<script>
										// Matches Datatable
										$(document).ready(function() {
										    matches_table = $('#job_record_diffs').dataTable({
										        "processing": true,
										        "serverSide": true,
										        "ajax": "{% url 'job_record_diffs' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}",
										        "searchDelay": 1000,
										        "pageLength": 10,
										        "order": [[ 1, "desc" ]],
										        "columns": [
										            {
										            	title: "DB ID"
									            	},
										            {
										            	title: "Record ID"
										            }
										        ],
										    });
										});
									</script>


								{% endif %}

								<!-- MergeJob -->
								{% if cjob.job.job_type_family == 'MergeJob' %}
									<p>No additional information at this time for Duplicate / Merge / Analysis jobs.</p>
								{% endif %}

								<!-- PublishJob -->
								{% if cjob.job.job_type_family == 'PublishJob' %}
									<p>No additional information at this time for Publish jobs.</p>
								{% endif %}

								<!-- AnalysisJob -->
								{% if cjob.job.job_type_family == 'AnalysisJob' %}
									<p>No additional information at this time for Analysis jobs.</p>
								{% endif %}

							</div>
						</div>
					</div>

					<!-- general Job details -->
					<div class="row">
						<div class="col-md-12">
							<h4>Job Runtime Details</h3>
							<div id="job_details_json" style="height:450px;"></div>
							<script>
						        // create the editor
						        var container = document.getElementById("job_details_json");
						        var options = {
						        	mode: 'code',
			    					modes: ['code', 'text', 'view'],
			    					sortObjectKeys: true,
			    					name: 'field_mapping_configuration',
			    					onModeChange: function(nm, om){
			    						if (nm == 'view'){
			    							$("#job_details_json").css('height','');
			    						}
			    						else {
			    							$("#job_details_json").css('height','450px');
			    						}
			    					},
			    					navigationBar:false
						        };
						        var job_details_editor = new JSONEditor(container, options);

						        // set json to editor
						        job_details_editor.set({{ cjob.job.job_details|safe }});
						    </script>
						</div>
					</div>

				</div>

				<div id="export_tab" class="tab-pane full_width_tab">
					
					<!-- export content -->
					{% include 'core/export.html' %}

				</div>

				<div id="spark_details_tab" class="tab-pane full_width_tab">
					<div class="row">
						<div class="col-md-12">
							<ul class="list-inline">
								<li style="display:inline;"><a href="http://{{APP_HOST}}:8998{{cjob.job.url}}" target="_blank"><button type="button" class="btn btn-primary btn-sm">Livy Statement</button></a></li>
								<li style="display:inline;"><a href="http://{{APP_HOST}}:8998/ui/session/{{LIVY_SESSION.session_id}}/log" target="_blank"><button type="button" class="btn btn-primary btn-sm">Livy Session Logs</button></a></li>
								<li style="display:inline;"><a href="http://{{APP_HOST}}:4040" target="_blank"><button type="button" class="btn btn-primary btn-sm">Spark Application GUI</button></a></li>
								<li style="display:inline;"><a href="http://{{APP_HOST}}:8080" target="_blank"><button type="button" class="btn btn-primary btn-sm">Spark Cluster GUI</button></a></li>
							</ul>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<h4>Spark Jobs/Tasks Run</h4>
							{% if cjob.job.get_spark_jobs %}
								<table class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>ID</th>
											<th>Description</th>
											<th>Name</th>
											<th>Status</th>
											<th>Completed / Total Tasks</th>
											<th>Submitted</th>
											<th>Completed</th>
											<th>Duration</th>
										</tr>
									</thead>
									<tbody>
										{% for spark_job in cjob.job.get_spark_jobs %}
											<tr class="{% if spark_job.status == 'FAILED' %}bg_light_red{% elif spark_job.status == 'RUNNING' %}bg_light_yellow{% elif spark_job.status == 'SUCCEEDED' %}bg_light_green{% endif %}">
												<td>{{ spark_job.jobId }}</td>
												<td>{{ spark_job.description }}</td>
												<td>{{ spark_job.name }}</td>
												<td>{{ spark_job.status }}</td>
												<td>{{ spark_job.numCompletedTasks }}/{{ spark_job.numTasks }}</td>
												<td>{{ spark_job.submissionTime }}</td>
												<td>{{ spark_job.completionTime }}</td>
												<td>{{ spark_job.duration_s }}</td>
										{% endfor %}
									</tbody>
								</table>
							{% else %}
							<p>Could not retrieve information about Spark Tasks/Jobs.</p>
							{% endif %}
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<h4>Livy Statement Information</h4>
							<div id="livy_statement" style="height:450px;"></div>
							<script>
						        // create the editor
						        var container = document.getElementById("livy_statement");
						        var options = {
						        	mode: 'view',
			    					modes: ['code', 'text', 'view'],
			    					sortObjectKeys: true,
			    					name: 'livy_response',
			    					onModeChange: function(nm, om){
			    						if (nm == 'view'){
			    							$("#livy_statement").css('height','');
			    						}
			    						else {
			    							$("#livy_statement").css('height','450px');
			    						}
			    					},
			    					navigationBar:false
						        };
						        var editor = new JSONEditor(container, options);

						        // set json to editor and expand
						        editor.set({{ cjob.job.response|safe }});
						        editor.expandAll();
						    </script>
						</div>
					</div>
				</div>

			</div>

		</div>
	</div>

{% endblock %}


