{% extends 'core/base.html' %}
{% block content %}

	<div>
		<h3>Job Details: <span class="{{ cjob.job.job_type }}">{{ cjob.job.name }}</span></h3>		
	</div>

	<div style="background-color:#E4E4E3; width:50%; padding:5px 10px 10px 10px; border-radius:10px;">
		<form method="POST" action="{% url 'job_update_note' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">
			{% csrf_token %}
			<h4>Notes</h4>			
			<p><textarea rows="5" cols="120" name="job_note" placeholder="No job notes found...">{{ cjob.job.note }}</textarea></p>
			<input type="hidden" name="job_id" value="{{ cjob.job.id }}">
			<input type="hidden" name="next" value="{{ request.path }}">
			<input type="submit" value="update notes">
		</form>
	</div>

	<p>The following jobs were used as input for this {{ cjob.job.job_type }}.  The counts indicate actual documents from previous jobs, not any errors that job may have generated.</p>
	<table border="1" cellpadding="5">
		<tr>
			<th>Input Job Name</th>
			<th>Record Count</th>
		</tr>
		{% for input_job in cjob.job.jobinput_set.all %}
		<tr class="{{ input_job.input_job.job_type }}">
			<td><a href="{% url 'job_details' org_id=input_job.input_job.record_group.organization.id record_group_id=input_job.input_job.record_group.id job_id=input_job.input_job.id %}">{{ input_job.input_job.name }}</a></td>
			<td>{{ input_job.input_job.record_count }}</td>
		</tr>
		{% endfor %}
		<tr>
			<td></td>
			<td><strong>Total:</strong> {{ record_count_details.input_jobs.total_input_records }}</td>
		</tr>
	</table>

	<p>Given the input jobs and records outlined above, the following table shows details about input records, successes, and failures.  Below that is a table with all records and errors for this job, searchable and sortable.</p>
	<table border="1" cellpadding="5">
		<tr>
			<th>This Job Name</th>
			<th>Total Input Records</th>
			<th>Sucesssful Records</th>
			<th>Errors</th>
			<th>Error Percentage</th>
		</tr>
		<tr class="{{ cjob.job.job_type }}">
			<td>{{ cjob.job.name }}</td>
			<td>{{ record_count_details.input_jobs.total_input_records }}</td>
			<td>{{ record_count_details.records }}</td>
			<td>{{ record_count_details.errors }}</td>
			<td>{{ record_count_details.error_percentage }}</td>
		</tr>
	</table>

	<div style="margin-top:20px;"/>
	
	<!-- Indexing Records DT Table -->
	{% include 'core/records_dt_table.html' %}

	<h4>Indexed Field Breakdown</h4>

	<p>To get a sense of how fields are used and distributed across a job, each record is mapped to a flat representation of its metadata, and then indexed in ElasticSearch.  The field names should suggest that corresponding metadata field from the original XML.</p>

	<p>
		<table border="1" cellpadding="5">
			<tr>
				<th>Total records for indexing</th>
				<th>Indexed</th>
				<th>Actions</th>
			</tr>
			<tr>
				<td>{{ record_count_details.records }}</td>
				<td>{{ field_counts.total_docs }}</td>
				<td><a href="http://{{ APP_HOST }}:9200/j{{ cjob.job.id }}/_search" target="_blank">Browse Index</a> / <a href="{% url 'job_indexing_failures' org_id=cjob.job.record_group.organization.id record_group_id=cjob.job.record_group.id job_id=cjob.job.id %}">View Errors</a></td>
			</tr>
		</table>
	</p>

	<!-- Indexed Fields Analysis DT Table -->
	{% include 'core/indexed_fields_dt_table.html' %}

{% endblock %}


