{% block content %}

	<p>Select Job as Input:</p>

	<div id="job_family_diagram_container">
		<style type="text/css">
			#job_family_diagram {
				width: 100%;
				height: 400px;
				border: 1px solid lightgray;
			}
		</style>
		<div id="job_family_diagram"></div>
		<script type="text/javascript">

			// parse job lineage json
			job_lineage = JSON.parse('{{ job_lineage_json|safe }}');

			// style nodes
			$(job_lineage.nodes).each(function(){
				styleNetworkNodes(this);						
			});

			// style edges
			$(job_lineage.edges).each(function(){
				styleNetworkEdges(this);
			});

			// init as viz data
			var nodes = new vis.DataSet(job_lineage.nodes);
			var edges = new vis.DataSet(job_lineage.edges);

			// create a network
			var container = document.getElementById('job_family_diagram');
			var data = {
				nodes: nodes,
				edges: edges
			};
			var options = {					
				clickToUse:false,
				interaction:{
					zoomView:false,
					multiselect: false,
					navigationButtons: true,
				},
				layout:{
					hierarchical: {
						enabled:true,
						levelSeparation: 600,
						nodeSpacing: 100,
						treeSpacing: 100,
						blockShifting: true,
						edgeMinimization: true,
						parentCentralization: true,
						direction: 'LR',        // UD, DU, LR, RL
						sortMethod: 'directed'   // hubsize, directed
					}
				}			  	
			};

			// fire network
			var network = new vis.Network(container, data, options);

			// fit all nodes in viewport
			network.fit();

			// set listener for node select
			network.on('selectNode', function (node){

				// fire ajax to get job lineage for selected job
				base_url = "{%url 'job_lineage_json' org_id='DYNAMIC_ORG_ID' record_group_id='DYNAMIC_RG_ID' job_id='DYNAMIC_ID' %}";
				
				// get node
				node_data = nodes.get(node.nodes[0])
				
				// update URL
				base_url = base_url.replace('DYNAMIC_ID', node_data.id);
				base_url = base_url.replace('DYNAMIC_ID', node_data.record_group_id);
				base_url = base_url.replace('DYNAMIC_ID', node_data.org_id);
				
				$.ajax({
					type: 'POST',
					url: base_url,
					dataType:'json',
					data: {							
						'csrfmiddlewaretoken': '{{ csrf_token }}'
					},
					success: function(data){
						
						// filter datatables
						search_string = data.job_id_list.join('|');
						job_id = node.nodes[0];
						jobs_table.column(0).search(search_string, true, false).draw();

						// gray out other nodes
						nodes.forEach(function(node){								
							if (!data.job_id_list.includes(node.id)){									
								node.color = '#efefef';
								nodes.update(node);
							}
						})
					}			
				});
				
			});

			// set listener for node deselect
			network.on('deselectNode', function (node){

				// reset table
				jobs_table.column(0).search('').draw();

				// reset node colors
				nodes.forEach(function(node){								
					styleNetworkNodes(node);
					nodes.update(node);
				})

			});

		</script>
	</div>

	<div>
		<table id="input_jobs_table" border="1" cellpadding="10">
			<thead>
				<tr>
					<th>Job ID</th>
					<th>Name</th>
					<th>Record Group</th>
					<th>Job Type</th>
					<th>Status</th>
					<th>Finished</th>
					<th>Is Valid</th>
					<th>Timestamp</th>
					<th>Input</th>
					<th>Notes</th>
					<th>Record Count</th>
					<th>Select</th>
				</tr>
			</thead>				
			<tbody>
			{% for job in input_jobs %}
				<tr class="{{ job.job_type_family }}">
					<td>{{ job.id }}</td>
					<td>{{ job.name }}</td>
					<td>{{ job.record_group.name }}</td>
					<td>{{ job.job_type_family }}</td>
					<td>{{ job.status }}</td>
					<td>{{ job.finished }}</td>
					<td>{{ job.validation_results.verdict }}</td>
					<td>{{ job.timestamp }}</td>
					<td>{% for input_job in job.jobinput_set.all %}
						<div class="{{ input_job.input_job.job_type_family }}" style="padding:10px; clear:both; border: 1px dotted black; margin-bottom:2px;">
							<a href="{% url 'job_details' org_id=input_job.input_job.record_group.organization.id record_group_id=input_job.input_job.record_group.id job_id=input_job.input_job.id %}">{{ input_job.input_job }}</a>
						</div>
					{% endfor %}</td>
					{% if 'hdfs://' in job.job_output %}
						<td><a href="http://{{ APP_HOST }}:50070/explorer.html#/user/combine/record_group/{{ record_group.id }}/jobs/harvest/{{ job.id }}" target="_blank">{{ job.job_output }}</a></td>
					{% else %}
						<td>{{ job.note }}</td>
					{% endif %}
					<td>{{ job.record_count }}</td>
					{% if job_select_type == 'single' %}
						<td><input type="radio" name="input_job_id" value="{{ job.id }}"></td>
					{% else %}
						<td><input type="checkbox" name="input_job_id" value="{{ job.id }}"></td>
					{% endif %}
				</tr>
			{% endfor %}
			</tbody>
			<tfoot>
				<tr>
					<th></th>
					<th></th>
					<th>Record Group</th>
					<th>Job Type</th>
					<th>Status</th>
					<th>Finished</th>
					<th></th>
					<th></th>
					<th></th>
					<th></th>
				</tr>
			</tfoot>
		</table>
		<script>
			$(document).ready(function() {
			    jobs_table = $('#input_jobs_table').DataTable({
			    	pageLength: 100,
			    	lengthMenu: [ 10, 25, 100, 500 ],
			    	createdRow: function( row, data, dataIndex){				    		
	                    $('td', row).addClass(data[3]);
	                    if (data[6] == 'False'){                    	
	                    	$('td:nth-child(7)', row).css('background-color','#ff9898');
	                    }
		            },
		            paging: false, // likely not too many jobs, sidesteps problem with paged checkboxes
		            initComplete: function () {
			            this.api().columns([2,3,4,5]).every( function () {
			                var column = this;
			                var select = $('<select><option value="">All</option></select>')
			                    .appendTo( $(column.footer()).empty() )
			                    .on( 'change', function () {				                    	
			                        var val = $.fn.dataTable.util.escapeRegex(
			                            $(this).val()
			                        );
			 
			                        column
			                            .search( val ? '^'+val+'$' : '', true, false )
			                            .draw();
			                    } );
			 
			                column.data().unique().sort().each( function ( d, j ) {
			                    select.append( '<option value="'+d+'">'+d+'</option>' )
			                } );
			            } );
			        }
			    });
			} );
		</script>
	</div>

{% endblock %}