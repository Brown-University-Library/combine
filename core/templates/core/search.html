{% extends 'core/base.html' %}

{% block content %}

	<div class="row">
		<div class="col-md-12">
			<h2>Search Records</h2>
			<p>This page allows <strong>full-text</strong> searching of all Records, across all Jobs, currently held in Combine.</p>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<h4>Advanced Search</h4>

			<!-- Org, RecordGroup, Job filters -->
			<div class="row">
				<div class="col-md-8">
					<h5>Organizations, Record Groups, Jobs</h5>
					<div class="tree_select">
						<p class="form-inline"><input id="jobs_search" type="text" class="form-control" style="width:300px;" placeholder="search..."/><button style="margin-left:5px;" type="button" class="btn btn-outline-danger btn-sm" onclick="$('#jobs_search').val('').keyup(); "><i class="la la-close"></i></button><button style="margin-left:5px;" type="button" class="btn btn-outline-success btn-sm" onclick="jobs_search_select_matches();">Select Matches <i class="la la-check"></i></button><button style="margin-left:5px;" type="button" class="btn btn-outline-warning btn-sm" onclick="jobs_search_deselect_matches();">De-Select Matches <i class="la la-close"></i></button></p>
						<div id="jobs_hierarchy_tree"></div>

						<script>

							search_config = {
								'show_only_matches':false, // isolate matches
								'delay':500, // delay for search keyup
								'fuzzy':false // fuzzy matching
							}

							// init hierarchy
							job_hierarchy_obj = JSON.parse(`{{job_hierarchy_json|safe|escapejs}}`);

							// init tree
							$(document).ready(function(){
								jobs_tree = $('#jobs_hierarchy_tree').jstree({
									'plugins':["wholerow","checkbox","search"],
									'core':{
										'data':job_hierarchy_obj
									},
									'search':search_config
								});
							});

							// search
							var to = false;
								$('#jobs_search').keyup(function () {
								if(to) { clearTimeout(to); }
									to = setTimeout(function () {
									var v = $('#jobs_search').val();
								$('#jobs_hierarchy_tree').jstree(true).search(v);
								}, search_config.delay);
							});

							// select matches
							function jobs_search_select_matches(){
								matches = $("#jobs_hierarchy_tree .jstree-search")
								matches.each(function(index, match){jobs_tree.jstree(true).select_node(match);});
							}

							// dselect matches
							function jobs_search_deselect_matches(){
								matches = $("#jobs_hierarchy_tree .jstree-search")
								matches.each(function(index, match){jobs_tree.jstree(true).deselect_node(match);});
							}

						</script>
					</div>

				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<h4>Search Results</h4>

			<table id='search_results' class="table table-bordered table-hover"></table>

			<script>

				// global data var
				data = {};

				function ajax_search() {

					// get search string if present
			    	{% if search_params %}
				    	search_params = JSON.parse('{{ search_params|safe|escapejs }}')
				    	q = search_params.q;
				    {% else %}
				    	q = '';
			    	{% endif %}

					// DataTable
				    table = $('#search_results').DataTable({
				        "processing": true,
				        "serverSide": true,
				        "ajax": {
				        	"url":"{% url 'records_es_generic_dt_json' %}",
				        	"data":data,
			        	},
				        "searchDelay": 1000,
				        "pageLength": 10,
				        "pagingType": "full_numbers",
				        "ordering":false,
				        "search": {
						    "search": q,
						    "smart": false
						},
				        "columns": [
				            {
				            	title: "DB ID",
				            	"render": function ( data, type, row ) {
				                    return "<a href='"+row[3]+"'>" + row[4] + "</a>";
				                }
			            	},
				            {
				            	title: "Combine ID",
				            	"render": function ( data, type, row ) {
				                    return "<a href='"+row[3]+"'>" + row[5] + "</a>";
				                }
			            	},
				            {
				            	title: "Record ID",
				            	"render": function ( data, type, row ) {
				                    return "<a href='"+row[3]+"'>" + row[6] + "</a>";
				                }
				            },
				            {
				            	title: "Organization",
				            	"render": function ( data, type, row ) {
				                    return row[0];
				                }
				            },
				            {
				            	title: "Record Group",
				            	"render": function ( data, type, row ) {
				                    return row[1];
				                }
				            },
				            {
				            	title: "Job",
				            	"render": function ( data, type, row ) {
				                    return row[2];
				                }
				            }
				        ]
				    }).on('preXhr.dt', function ( e, settings, data ) {

				    	console.log('pre ajax work...');

				    	// collect jobs filters
				    	data.jobs = jobs_tree.jstree(true).get_selected();

				    });
				};

				// fire search on page load
				$(document).ready(function(){
					ajax_search();
				})

			</script>

		</div>
	</div>

{% endblock %}