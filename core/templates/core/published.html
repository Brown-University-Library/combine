{% extends 'core/base.html' %}

{% block content %}
{% load core_template_filters %}

<div class="row">
	<div class="col-md-12">
		<h3>Published Records</h3>
	</div>
</div>

{% if published.records.count == 0 %}

	<div class="row">
		<div class="col-md-12">
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
				No Record Groups have been published yet!  <a href="http://combine.readthedocs.io/en/master/publishing.html">Read more about Publishing Records here...</a>
				<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
		</div>
	</div>


{% else %}

<div class="row">
	<div class="col-md-6">
		<h4>Published Sets</h4>
		
		<p>Showing all published Record Groups, where one Job from each Record Group may be published with an optional <code>Publish Set ID</code>.  This <code>Publish Set ID</code> is used during publishing for the outgoing OAI set.  In some cases this may be <span class="text-danger">"None"</span>, resulting in Records that are not aggregated under an OAI set, but will be returned via <code>ListRecords</code>.</p>

		<table class="table table-bordered table-hover">

			<tr>
				<th>Publish Set ID</th>
				<th>Record Group</th>				
				<th>Published Job</th>
				<th>Record Count</th>
				<th>Action</th>
			</tr>

			{% for job in published.published_jobs %}
				<tr>
					<td>
						{% if job.publish_set_id %}
							<a href="{% url 'oai' %}?verb=ListRecords&set={{ job.publish_set_id }}" target="_blank">{{ job.publish_set_id }}</a>
						{% else %}
							<span style="color:red;"><strong>None</strong></span>
						{% endif %}
					</td>
					<td><a href="{% url 'record_group' org_id=job.record_group.organization.id record_group_id=job.record_group.id %}">{{ job.record_group.name }}</a></td>
					<td class="{{ job.job_type }} {% if job.deleted %}deleted{% endif %}"><a href="{% url 'job_details' org_id=job.record_group.organization.id record_group_id=job.record_group.id job_id=job.id %}">{{ job.name }}</a></td>
					<td>{{ job.record_count }}</td>
					<td><a href="{% url 'job_unpublish' org_id=job.record_group.organization.id record_group_id=job.record_group.id job_id=job.id %}"><button type="button" class="btn btn-danger btn-sm">Unpublish</button></a></td>
				</tr>
			{% endfor %}

			<tr>
				<td></td>
				<td></td>
				<td><strong>Total:</strong></td>
				<td><strong>{{ published.records.count }}</strong></td>
				<td></td>
			</tr>

		</table>

	</div>

	<div class="col-md-6">
		<h4>Analysis</h4>
		<p>Run Analysis over all Published Records.  This may be useful for double checking uniqueness, record validity, or checking existence in previous DPLA bulk data sets.</p>
		<a href="{% url 'job_analysis' %}?type=published"><button type="submit" class="btn btn-success btn-sm">Run Analysis for Published Records</button></a>
	</div>

</div>

<div class="row">
	<div class="col-md-12">

		<!-- Navigation -->
		<ul id="tabs" class="nav nav-tabs">								
			<li class="nav-item">
				<a class="nav-link active" data-toggle="tab" href="#records_tab">Records</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#oai_server">Outgoing OAI-PMH Server</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#export_flat_files">Export Flat Files</a>
			</li>
		</ul>

		<!-- Tabbed Content -->
		<div class="tab-content">

			<!-- Records -->
			<div id="records_tab" class="tab-pane full_width_tab active">
				<div class="row">
					<div class="col-md-12">

						<h4>Published Records</h4>

						<p>The table belows shows all published records, across all Record Groups and OAI sets.</p>

						<table id="published_records" class="table table-hover">
							<thead>
								<th>ID</th>
								<th>Record ID</th>
								<th>Record Group</th>
								<th>Publish Set ID</th>
								<th>Harvested OAI set</th>
								<th>Unique Record ID</th>
								<th>Document</th>
							</thead>
							<tbody>
							</tbody>
						</table>

						<script>
							$(document).ready(function() {
							    var oTable = $('#published_records').dataTable({
							        "processing": true,
							        "serverSide": true,
							        "ajax": "{% url 'published_dt_json' %}",
							        "searchDelay": 1000,
							        "pageLength": 10
							    });
							});
						</script>

					</div>
				</div>
			</div>

			<!-- OAI-PMH Server -->
			<div id="oai_server" class="tab-pane full_width_tab">
				<div class="row">
					<div class="col-md-12">

						<h4>Outgoing OAI-PMH Server</h4>

						<p>Combine comes with a built-in <a href="https://www.openarchives.org/pmh/">OAI-PMH</a> server that serves Published Records via the OAI protocol and HTTP requests.</p>

						<ul>
							<li><a href="{% url 'oai' %}?verb=Identify" target="_blank">Identify</a></li>
							<li><a href="{% url 'oai' %}?verb=ListIdentifiers" target="_blank">List Identifiers</a></li>
							<li><a href="{% url 'oai' %}?verb=ListRecords" target="_blank">List Records</a></li>
							<li><a href="{% url 'oai' %}?verb=ListSets" target="_blank">List Sets</a></li>
						</ul>

					</div>
				</div>
			</div>

			<!-- Export -->
			<div id="export_flat_files" class="tab-pane full_width_tab">
				<div class="row">		
					<div class="col-md-12">

						<p>Similar to single Jobs, Published Records may be exported in two ways (<a href="https://combine.readthedocs.io/en/master/workflow.html#export">see documentation for more information</a>):
							<ul>
								<li><strong>Documents (XML)</strong>: The actual XML documents for each Record, as harvested and/or transformed.</li>
								<li><strong>Mapped Fields (tabular)</strong>: Records are also <a href="http://combine.readthedocs.io/en/master/analysis.html#analyzing-indexed-fields">indexed into ElasticSearch</a>, resulting in a flat, tabular format of the data from the Records.</li>
							</ul>
						</p>

						<div class="alert alert-info alert-dismissible fade show" role="alert">
							Select a tab below to export Published Records as <strong>full XML Documents</strong>, or <strong>tabular Mapped Fields</strong>
							<button type="button" class="close" data-dismiss="alert" aria-label="Close">
							<span aria-hidden="true">&times;</span>
							</button>
						</div>
						
						<ul id="export_tabs" class="nav nav-tabs">								
							<li class="nav-item">
								<a class="nav-link active" data-toggle="tab" href="#export_documents">Export Documents</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" data-toggle="tab" href="#export_mapped_fields">Export Mapped Fields</a>
							</li>							
						</ul>

						<div class="tab-content">			

							<div id="export_mapped_fields" class="tab-pane full_width_tab">
								<div class="row">		
									<div class="col-md-12">

										<!-- form for Job mapped fields export -->
										<form method="POST" id="export_mapped_form" action="{% url 'published_export_mapped_fields' %}">

											{% csrf_token %}

											<div class="form-group">
												<div class="form-check">
													<input class="form-check-input" type="checkbox" value="true" id="kibana_style" name="kibana_style"/>
													<label class="form-check-label" for="kibana_style">
														Check this box to export repeating fields "Kibana style" <button type="button" class="btn btn-outline-info btn-sm" onclick="$('#kibana_style_info').fadeToggle();">More Information</button>
													</label>
												</div>
												<div id="kibana_style_info" class="bg-light" style="padding:20px; border-radius:5px; display: none;">
													<p>"Kibana style" is referring to the <a href="https://www.elastic.co/products/kibana">Kibana application</a> for visualize and analyzing ElasticSearch indexes, and addresses fields that have <strong>multiple values</strong>.</p>

													<p>For example, consider an ElasticSearch field called <code>mods_subject_topic</code>, with multiple values of <code>history</code>, <code>boating</code>, and <code>typing</code>.  If Kibana style is <strong>not</strong> checked/used -- which is the default behavior -- this would result in three distinct columns in the generated .csv file with a number affixed to the field name: <code>mods_subject_topic.0</code> with the value <code>historyM</code>, <code>mods_subject_topic.1</code> with the value <code>boating</code>, and <code>mods_subject_topic.2</code> with the value <code>typing</code>.  This can handy for analysis, as distinct values for this field are in distinct columns.</p>

													<p>But some pipelines are prepared for fields that are comman separated when repeating, e.g. Kibana.  If checked, the result would be a <strong>single</strong> field called <code>mods_subject_topic</code> and a single, comma separated value of <code>history,boating,typing</code>.
												</div>
											</div>

											<div style="width:50%;">
												<div class="form-group">
													<label for="archive_type">Select archive file type</label>
													<select class="form-control" id="archive_type" name="archive_type" required>
														<option value="none">Uncompressed CSV file</option>
														<option value="zip">Compressed Zip file</option>
														<option value="targz">Compressed Tar file</option>
													</select>
												</div>
											</div>

											<p>By default, <strong>all</strong> mapped fields are included in the report, but you may optionally select a smaller subset of fields to export by clicking the button below.</p>
											<p><a href="#" onclick="$('#mapped_fields').toggle(); update_table_widths(); return false;"><button type="button" class="btn btn-outline-primary btn-sm">Select Mapped Fields for Export</button></a></p>
											<div id="mapped_fields" style="display:none;">													
												<p><button type="button" class="btn btn-primary btn-sm" onclick="return false;" id="select_all_fields">Toggle all fields</button></p>
												<table id="mapped_field_export_select" class="table table-bordered table-hover">
													<thead>
														<tr>
															<th>Field Name</th>															
															<th>Documents with Field (of total {{ field_counts.total_docs }})</th>
															<th>Documents without</th>
															<th>Count of Total Values for Field</th>
															<th>Count of Distinct Values for Field</th>
															<th>Percentage of Field Values that are Unique</th>
															<th>Instance of Field in Total Indexed Records</th>
															<th>Include in Report</th>
														</tr>
													</thead>
													<tbody>
														{% for field in field_counts.fields %}
															<tr>
																<td {% if field.one_distinct_per_doc %}style="background-color:yellow;"{% endif %}><a href="{% url 'field_analysis' es_index=published.esi.es_index %}?field_name={{ field.field_name }}" target="_blank">{{ field.field_name }}</a></td>
																<td><a target="_blank" href="{% url 'field_analysis_docs' es_index=published.esi.es_index filter_type='exists' %}?field_name={{ field.field_name }}&exists=true">{{ field.doc_instances }}</a></td>
																<td><a target="_blank" href="{% url 'field_analysis_docs' es_index=published.esi.es_index filter_type='exists' %}?field_name={{ field.field_name }}&exists=false">{{ field.doc_missing }}</a></td>
																<td>{{ field.val_instances }}</td>
																<td>{{ field.distinct }}</td>
																<td>
																	<div class="percentage_div" style="{% if field.distinct_ratio >= 0.5 %}padding:2px;{% else %}padding:0px;{% endif %} width:{% if field.distinct_ratio > 0 %}{% widthratio field.distinct_ratio 1 100 %}{% else %}0{% endif %}%">
																		<span>{% widthratio field.distinct_ratio 1 100 %}%</span>
																	</div>
																</td>
																<td>
																	<div class="percentage_div" style="{% if field.percentage_of_total_records >= 0.5 %}padding:2px;{% else %}padding:0px;{% endif %} width:{% if field.percentage_of_total_records > 0 %}{% widthratio field.percentage_of_total_records 1 100 %}{% else %}0{% endif %}%">
																		<span>{% widthratio field.percentage_of_total_records 1 100 %}%</span>
																	</div>
																</td>
																<td><input type="checkbox" name="mapped_field_include_dynamic" value="{{ field.field_name }}"/></td>
															</tr>
														{% endfor %}
													</tbody>
												</table>
												<div id="hidden_field_inputs"></div>
											</div>

											<button id="form_submit_button" type="button" class="btn btn-success btn-sm">Export Published Mapped Fields</button>

											<script>

												$(document).ready(function() {

													// init datatables
												    mapped_field_export_select_table = $('#mapped_field_export_select').DataTable({
												    	"pageLength": 10,
												    	"lengthMenu": [ 10, 25, 100, 500 ]
												    });

												    // listener for checkboxes
												    $("#select_all_fields").click(function(){			    	
													    cells = mapped_field_export_select_table.cells().nodes();						    
													    $(cells).find(':checkbox').prop("checked", !$(cells).find(':checkbox').prop("checked"));
												    });

													// submit form via javascript
												    /*
												    Because the input checkboxes for a DataTable are dynamic, Django's normal method of .getlist() does not
												    work, as it cannot capture checkboxes not currently rendered on the page.  This workaround writes
												    temporary hidden inputs to the form before submit, clearing any pre-existing before submit as well.
												    
												    Django picks up the form name "mapped_field_include", not "mapped_field_include_dynamic" from the actual
												    DataTable.
												    */
												    $("#form_submit_button").click(function(){

												    	// remove any pre-existing temp, hidden inputs
												    	$("#hidden_field_inputs input").each(function(){
												    		$(this).remove();
												    	});

												    	// write all field checkboxes as temporary, hidden inputs
												    	cells = mapped_field_export_select_table.cells().nodes();
												    	checkboxes = $(cells).find(':checked');
												    	checkboxes.each(function(){
												    		console.log(this);
												    		$("#hidden_field_inputs").append("<input class='hidden_input' type='hidden' name='mapped_field_include' value='"+$(this).attr('value')+"'/>")
												    	});

												    	// submit form
												    	$("#export_mapped_form").submit();

												    });
											    });

											</script>

										</form>

									</div>
								</div>
							</div>

							<div id="export_documents" class="tab-pane full_width_tab active">
								<div class="row">		
									<div class="col-md-6">
										<!-- form for Job mapped fields export -->
										<form method="POST" action="{% url 'published_export_documents' %}">

											{% csrf_token %}

											<div class="form-group">
												<label for="records_per_file">XML Records per file</label>
												<input type="text" class="form-control" name="records_per_file" id="records_per_file" placeholder="e.g. 500 (default)">
												<small id="records_per_file_help" class="form-text text-muted">Optional</small>
											</div>

											<div class="form-group">
												<label for="archive_type">Select archive file type</label>
												<select class="form-control" id="archive_type" name="archive_type" required>
													<option value="zip">Zip file</option>
													<option value="tar">Tar file</option>
												</select>
											</div>

											<button type="submit" class="btn btn-success btn-sm">Export Published Documents</button>

										</form>
									</div>
								</div>
							</div>

						</div>

					</div>
				</div>
			</div>

		</div>

	</div>
</div>

{% endif %}

{% endblock %}